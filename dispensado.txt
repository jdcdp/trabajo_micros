/*

 * GccApplication2.c

 *

 * Created: 19/04/2019 0:18:18

 * Author : junti

 $$$$$$$$$$$$$$$$$$$$$$$$$$$$$ OJO REINICIALIZAR VARIBLES GLOBALES $$$$$$$$$$$$$$$$$$$$$$$$$$$

 */ 



#include <avr/io.h>

#include <avr/interrupt.h>

#include <stdint.h>



#define MAX_LOOPS 8 // Hay que prolongarlo un poco más del numero de vueltas necesario para cuando el producto está al final para evitar que haya confusión de que si se para porque se ha acabado o porque ha caido



uint8_t ARRIVED_POSITION = 1;

uint8_t MONEY_CORRECT = 1;

uint8_t NOT_DROPPING = 1;

uint8_t sw8_signals = 0;

uint8_t DROPPED = 0;

uint8_t ALREADY_SELECTED = 1; //Manejar en conjunto con keypad



void setup()

{
	cli();
	
	DDRD = 0b01010110; // l1 PD1
	PORTD=0x00;

	DDRB = 0x00; //SW8 PB5++SP1 PB1 -- Solo para depurar
	
	DDRK = 0b10000000; //M4 PK7 -- Solo para depurar
	PORTK=0x00;

	PCICR = 0b00000001;//PCINT 0-7

	PCMSK0 = 0b00100010; //Solo para depurar
	
	
	//----------------
	DDRL=0xFF;
	PORTL=0x00;
	
	sei();
}



void drop_sweets()

{
	cli();
	
	PCMSK0 = 0b00100010; //Habilito SW8 y SP1
	
	PORTK = 0b10000000; //Enable M4


	sei();
	
	NOT_DROPPING = 0;

}



void stop()

{

	PORTK = 0x00; //Disable M4

	PCMSK0 = 0x00; //Disable SW8 and SP1

	NOT_DROPPING = 1;
	MONEY_CORRECT=0; //Mirar para varios productos

}



void send_position(int pos)

{

/*Por determinar*/

}



ISR(PCINT0_vect)
{

	if((PINB & 0b00100000) == 0) //No sé si para distinguir los diferentes PCINT se puede hacer así

	{

		sw8_signals++;

	}

	if((PINB & 0b00000010) == 0)

	{

		DROPPED = 1;

	}

}



void reset_position()

{

	send_position(0);

	ALREADY_SELECTED = 0;

	sw8_signals = 0;

}



int main(void)

{

	setup();

	while (1) 

    {

		if( MONEY_CORRECT && ARRIVED_POSITION && NOT_DROPPING)

		{

			drop_sweets(); //Hacerlo de esta manera nos permite no bloquear el main y poder atender a otras funciones llamadas en el main

		}

		if( DROPPED || (sw8_signals >= 4*MAX_LOOPS )) //Por cada vuelta SW8 genera 4 señales
		{

			stop();

			if(DROPPED)
			{

				reset_position();
				DROPPED=0;
			} 
			else
			{

				PORTD = 0b00000010; //Enciendo L1

				reset_position();

				//PORTD = 0x00;

			}

		}

    }

}